<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xô Phim - Phim hay cả Xổ - của Đức nhé !</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --bg-body: #14171c;
            --bg-nav: #1a1d23;
            --text-main: #ffffff;
            --text-dim: #a0a0a0;
            --accent: #f1c40f; /* Màu vàng icon */
            --search-bg: #252931;
            --mobile-card-bg: #3b4b7a; /* Màu xanh đặc trưng trên mobile */
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            overflow-x: hidden;
            /* Chống bôi đen văn bản để bảo vệ nội dung */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* --- HEADER DESKTOP --- */
        header {
            background-color: transparent; 
            height: 70px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            position: fixed; 
            width: 100%;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
        }

        header.scrolled {
            background-color: rgba(26, 29, 35, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #2d323a;
        }

        .container {
            width: 100%;
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-wrapper {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: white;
            min-width: 150px;
            transition: var(--transition);
        }

        .logo-wrapper:hover {
            transform: scale(1.05);
        }

        .logo-icon {
            font-size: 32px;
            color: var(--accent);
            margin-right: 10px;
        }

        .logo-text h1 {
            font-size: 22px;
            line-height: 1;
        }

        .logo-text span {
            font-size: 11px;
            color: var(--text-dim);
        }

        .search-container {
            background: var(--search-bg);
            border-radius: 6px;
            display: flex;
            align-items: center;
            padding: 8px 15px;
            margin: 0 20px;
            flex: 0 1 350px;
            transition: var(--transition);
            border: 1px solid transparent;
        }

        .search-container:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 10px rgba(241, 196, 15, 0.2);
        }

        .search-container i {
            color: var(--text-dim);
            margin-right: 10px;
        }

        .search-container input {
            background: transparent;
            border: none;
            color: white;
            outline: none;
            width: 100%;
            font-size: 14px;
        }

        .nav-main {
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .nav-link {
            text-decoration: none;
            color: #ddd;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            transition: var(--transition);
            position: relative;
            padding: 10px 0; 
            cursor: pointer;
        }

        .nav-link:hover {
            color: var(--accent);
            transform: translateY(-2px);
        }

        .nav-link i {
            font-size: 10px;
            margin-left: 3px;
        }

        .dropdown {
            position: relative;
        }

        .dropdown::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            height: 20px;
            display: block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            background: #1a1d23;
            min-width: 450px;
            padding: 20px;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            margin-top: 15px;
            opacity: 0;
            transition: var(--transition);
            border: 1px solid #333;
            z-index: 1001; 
        }

        .dropdown.open .dropdown-content {
            display: grid;
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .dropdown-content a {
            color: #ccc;
            text-decoration: none;
            font-size: 13px;
            padding: 8px;
            border-radius: 4px;
            transition: var(--transition);
            display: block;
            opacity: 1 !important; 
            transform: none !important;
        }

        .dropdown-content a:hover {
            color: var(--accent);
            background: rgba(255,255,255,0.05);
            padding-left: 12px;
        }

        .badge-new {
            background: #f39c12;
            color: #000;
            font-size: 9px;
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: bold;
            margin-right: 4px;
        }

        .user-action button {
            background: #f0f0f0;
            color: #333;
            border: none;
            padding: 8px 18px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }

        .user-action button:hover {
            background: var(--accent);
            transform: scale(1.05);
        }

        .btn-mobile {
            display: none;
            font-size: 22px;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-mobile:active {
            transform: scale(0.8);
        }

        /* THU GỌN MOBILE SEARCH */
        .mobile-search-overlay {
            position: fixed;
            top: 70px;
            left: 0;
            width: 100%;
            height: auto;
            background: var(--bg-nav);
            z-index: 999;
            display: none;
            padding: 15px;
            border-bottom: 2px solid var(--accent);
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .mobile-search-overlay.active {
            display: block;
        }

        .search-mobile-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-mobile-bar {
            background: var(--search-bg);
            border-radius: 6px;
            display: flex;
            align-items: center;
            padding: 10px 15px;
            flex-grow: 1;
            border: 1px solid #444;
        }

        .search-mobile-bar input {
            background: transparent;
            border: none;
            color: white;
            outline: none;
            width: 100%;
            font-size: 16px;
        }

        .close-search-mobile {
            font-size: 20px;
            color: #ff6b6b;
            cursor: pointer;
            padding: 5px;
        }

        .mobile-nav-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding-top: 40px;
            backdrop-filter: blur(5px);
        }

        .mobile-nav-overlay.active {
            display: flex;
        }

        .mobile-menu-card {
            background-color: var(--mobile-card-bg);
            width: 90%;
            max-width: 400px;
            border-radius: 15px;
            padding: 40px 25px 30px;
            position: relative;
            max-height: 85vh;
            overflow-y: auto;
            transform: translateY(-20px);
            transition: var(--transition);
        }

        .mobile-nav-overlay.active .mobile-menu-card {
            transform: translateY(0);
        }

        .close-mobile {
            position: absolute;
            top: 15px;
            left: 20px;
            font-size: 28px;
            color: #ff6b6b;
            cursor: pointer;
            transition: var(--transition);
        }

        .close-mobile:hover {
            transform: rotate(90deg);
        }

        .mobile-user-btn {
            background: #f0f0f0;
            color: #333;
            width: 100%;
            padding: 12px;
            border-radius: 25px;
            border: none;
            font-weight: bold;
            margin-bottom: 30px;
            font-size: 16px;
            transition: var(--transition);
        }

        .mobile-user-btn:active {
            transform: scale(0.95);
            background: var(--accent);
        }

        .mobile-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .mobile-grid a, .mobile-collapse-btn {
            color: white;
            text-decoration: none;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            padding: 5px 0;
            transition: var(--transition);
        }

        .mobile-grid a:active, .mobile-collapse-btn:active {
            color: var(--accent);
            padding-left: 10px;
        }

        .mobile-collapse-content {
            max-height: 0;
            overflow: hidden;
            grid-column: span 2;
            background: rgba(0,0,0,0.2);
            padding: 0 10px;
            border-radius: 8px;
            margin-top: -10px;
            transition: max-height 0.4s ease-out, padding 0.3s ease;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            opacity: 0;
        }

        .mobile-collapse-content.active {
            max-height: 500px; 
            padding: 15px 10px;
            opacity: 1;
            gap: 10px;
        }

        .mobile-collapse-content a {
            font-size: 14px;
            color: #ddd;
            padding: 8px 0;
            opacity: 0;
            transform: translateX(-10px);
            transition: all 0.3s ease;
        }

        .mobile-collapse-content.active a {
            opacity: 1;
            transform: translateX(0);
        }

        .mobile-collapse-content a:hover {
            color: var(--accent);
        }

        .hero-slider {
            position: relative;
            width: 100%;
            height: 80vh; /* Tăng chiều cao để giống ảnh */
            overflow: hidden;
            background: #000;
        }

        .slider-container {
            display: flex;
            width: 100%;
            height: 100%;
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .slide-item {
            min-width: 100%;
            height: 100%;
            position: relative;
        }

        .slide-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .slide-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to right, rgba(0,0,0,0.85) 30%, rgba(0,0,0,0.2) 60%, transparent 100%);
            display: flex;
            align-items: center;
            padding: 0 8%;
        }

        .slide-content {
            max-width: 650px;
            animation: slideUp 0.8s ease forwards;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .featured-tag {
            color: var(--accent);
            text-transform: uppercase;
            font-size: 14px;
            letter-spacing: 2px;
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
        }

        .slide-content h2 {
            font-size: clamp(32px, 5vw, 60px);
            margin-bottom: 15px;
            line-height: 1.1;
            font-weight: 800;
            text-transform: uppercase;
        }

        .slide-meta {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .meta-text {
            color: #ccc;
            font-size: 16px;
        }

        .imdb-badge {
            background: var(--accent);
            color: black;
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: 900;
            font-size: 14px;
        }

        .slide-desc {
            color: #eee;
            line-height: 1.6;
            margin-bottom: 35px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            font-size: 16px;
        }

        .hero-btn-group {
            display: flex;
            gap: 15px;
        }

        .btn-hero {
            padding: 12px 35px;
            border-radius: 30px;
            font-weight: bold;
            text-decoration: none;
            font-size: 15px;
            transition: 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-play-hero {
            background: var(--accent);
            color: black;
            border: none;
        }

        .btn-play-hero:hover {
            transform: scale(1.05);
            filter: brightness(1.1);
        }

        .btn-trailer-hero {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid white;
        }

        .btn-trailer-hero:hover {
            background: white;
            color: black;
        }

        .slider-thumbnails {
            position: absolute;
            bottom: 40px;
            right: 50px;
            display: flex;
            gap: 15px;
            z-index: 10;
        }

        .thumb-item {
            width: 100px;
            height: 56px;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            opacity: 0.5;
            transition: 0.3s;
        }

        .thumb-item.active {
            border-color: var(--accent);
            opacity: 1;
            transform: translateY(-5px);
        }

        .thumb-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .interest-section {
            max-width: 1600px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .interest-section h3 {
            font-size: 20px;
            margin-bottom: 20px;
        }

        .interest-grid {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding-bottom: 10px;
            scroll-snap-type: x mandatory;
        }

        .interest-grid::-webkit-scrollbar {
            display: none;
        }

        .interest-grid {
            scrollbar-width: none;
        }

        .interest-card {
            min-width: 160px;
            height: 100px;
            border-radius: 12px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: 0.3s;
            cursor: pointer;
            text-decoration: none;
            color: white;
            scroll-snap-align: start;
            flex-shrink: 0;
        }

        .interest-card:hover {
            transform: translateY(-5px);
            filter: brightness(1.1);
        }

        .interest-card span {
            font-size: 18px;
            font-weight: bold;
        }

        .interest-card i {
            font-size: 12px;
            margin-left: 5px;
        }

        .movie-list-section {
            max-width: 1600px;
            margin: 50px auto;
            padding: 0 20px;
            position: relative; 
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .list-header h3 {
            font-size: 20px;
            border-left: 4px solid var(--accent);
            padding-left: 15px;
        }

        .movie-scroll {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding-bottom: 15px;
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth; 
        }

        .movie-scroll::-webkit-scrollbar {
            height: 4px;
            background: #252931;
        }

        .movie-scroll::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 4px;
        }

        .movie-item {
            min-width: 160px;
            max-width: 160px;
            flex-shrink: 0;
            scroll-snap-align: start;
            cursor: pointer;
            transition: 0.3s;
        }

        .movie-item:hover {
            transform: translateY(-8px);
        }

        .movie-thumb {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 2/3;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .movie-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .movie-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0,0,0,0.75);
            color: var(--accent);
            padding: 2px 6px;
            font-size: 9px;
            border-radius: 4px;
            font-weight: bold;
        }

        .movie-title {
            margin-top: 10px;
            font-weight: 500;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .slide-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background: rgba(26,29,35,0.85);
            color: white;
            border-radius: 50%;
            border: 1px solid #444;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: var(--transition);
            opacity: 0;
        }

        .movie-list-section:hover .slide-btn {
            opacity: 1;
        }

        .slide-btn:hover {
            background: var(--accent);
            color: black;
            border-color: var(--accent);
        }

        .btn-left { left: 5px; }
        .btn-right { right: 5px; }

        /* --- PHẦN TOP 10 DESIGN MỚI (DÙNG LABEL THAY VÌ SỐ LỚN) --- */
        .movie-scroll-top10 {
            display: flex;
            overflow-x: auto;
            gap: 15px; 
            padding-bottom: 20px;
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
        }

        .movie-scroll-top10::-webkit-scrollbar {
            display: none;
        }

        .movie-scroll-top10 {
            scrollbar-width: none;
        }

        .movie-item-top10 {
            position: relative;
            min-width: 160px;
            max-width: 160px;
            flex-shrink: 0;
            scroll-snap-align: start;
            cursor: pointer;
            transition: var(--transition);
        }

        .movie-item-top10:hover {
            transform: translateY(-8px);
        }

        .top10-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: linear-gradient(45deg, #f1c40f, #f39c12);
            color: #000;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 900;
            font-size: 12px;
            z-index: 5;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            gap: 4px;
            text-transform: uppercase;
        }

        .top10-thumb {
            position: relative;
            width: 100%;
            aspect-ratio: 2/3;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.05);
        }

        .top10-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .top10-meta {
            margin-top: 12px;
        }

        .top10-title {
            font-weight: 600;
            font-size: 14px;
            color: #fff;
            margin-bottom: 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .top10-sub {
            font-size: 11px;
            color: var(--text-dim);
            margin-bottom: 5px;
        }

        .top10-info {
            font-size: 11px;
            color: var(--accent);
            font-weight: bold;
        }

        /* --- PHẦN TOP 10 BOM TẤN (SỐ ĐÃ CHỈNH BÉ LẠI) --- */
        .movie-scroll-bomtan {
            display: flex;
            overflow-x: auto;
            gap: 25px;
            padding: 20px 10px 40px 15px;
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
        }
        .movie-scroll-bomtan::-webkit-scrollbar { display: none; }
        
        .bomtan-item {
            min-width: 180px;
            scroll-snap-align: start;
            cursor: pointer;
            position: relative;
            transition: var(--transition);
        }
        .bomtan-item:hover { transform: translateY(-10px); }
        
        .bomtan-rank {
            position: absolute;
            bottom: -5px;
            left: -10px;
            font-size: 40px; 
            font-weight: 900;
            color: var(--bg-body);
            line-height: 1;
            z-index: 10;
            font-style: italic;
            -webkit-text-stroke: 1.5px var(--accent);
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
        }
        
        .bomtan-thumb {
            width: 100%;
            aspect-ratio: 2/3;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.6);
            position: relative;
            z-index: 5;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .bomtan-thumb img { width: 100%; height: 100%; object-fit: cover; }
        
        .bomtan-meta { margin-top: 12px; padding-left: 15px; }
        .bomtan-title { font-weight: bold; font-size: 14px; color: #fff; margin-bottom: 5px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .bomtan-info { font-size: 11px; color: var(--accent); font-weight: bold; }

        /* --- PHẦN TOP 10 PHIM LẺ (SỐ THỨ TỰ NẰM DƯỚI) --- */
        .movie-scroll-top10le {
            display: flex;
            overflow-x: auto;
            gap: 20px;
            padding: 20px 0 40px 0;
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
        }
        .movie-scroll-top10le::-webkit-scrollbar { display: none; }
        .top10le-item {
            min-width: 200px;
            scroll-snap-align: start;
            cursor: pointer;
            position: relative;
            transition: var(--transition);
        }
        .top10le-item:hover { transform: translateY(-5px); }
        .top10le-thumb {
            width: 100%;
            aspect-ratio: 2/3;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .top10le-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .top10le-info {
            margin-top: 15px;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        .top10le-rank {
            font-size: 40px;
            font-weight: 900;
            color: var(--accent);
            line-height: 1;
            font-style: italic;
        }
        .top10le-detail { flex: 1; }
        .top10le-title { font-weight: bold; font-size: 14px; color: #fff; margin-bottom: 3px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .top10le-sub { font-size: 11px; color: var(--text-dim); margin-bottom: 3px; }
        .top10le-meta { font-size: 11px; color: #888; }

        .popup-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 5000;
            display: none;
            overflow-y: auto;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .popup-content {
            max-width: 1100px;
            margin: 20px auto;
            background: var(--bg-nav);
            border-radius: 15px;
            display: block; /* Đổi sang block để video full width */
            padding: 25px;
            position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        .popup-poster-inline {
            width: 200px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            margin-right: 25px;
            float: left;
        }

        .close-popup {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #ff4d4d;
            transition: 0.2s;
            z-index: 10;
        }

        .close-popup:hover {
            transform: rotate(90deg);
        }

        .player-wrapper {
            width: 100%;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 16/9;
            margin: 15px 0 20px 0;
            border: 1px solid #333;
            position: relative;
            -webkit-overflow-scrolling: touch;
        }

        .player-wrapper iframe {
            width: 100%;
            height: 100%;
            border: none;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 5;
        }

        .lang-selector {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .lang-btn {
            background: #252931;
            border: 1px solid #444;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
        }

        .lang-btn.active {
            background: var(--accent);
            color: black;
            border-color: var(--accent);
            font-weight: bold;
        }

        .episode-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            padding-right: 5px;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 8px;
        }

        .ep-btn {
            background: #252931;
            border: 1px solid #333;
            color: white;
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: 0.2s;
        }

        .ep-btn:hover, .ep-btn.active {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(241, 196, 15, 0.1);
        }

        /* --- XEM CHUNG & CHAT SYSTEM CSS --- */
        .watch-party-layout {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
            border-top: 1px solid #333;
            padding-top: 20px;
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(90deg, #1e2128, #252931);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--accent);
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #ff4d4d;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 12px;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #ff4d4d;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.5; }
            100% { transform: scale(1); opacity: 1; }
        }

        .party-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }

        .chat-section {
            background: #1a1d23;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            height: 450px;
            border: 1px solid #333;
            position: relative;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message-item {
            background: rgba(255,255,255,0.05);
            padding: 10px;
            border-radius: 8px;
            max-width: 90%;
        }

        .message-item .user-name {
            color: var(--accent);
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 4px;
            display: block;
        }

        .message-item .text { font-size: 13px; line-height: 1.4; color: #eee; }

        .chat-input-wrapper {
            padding: 15px;
            background: #252931;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            display: flex;
            gap: 10px;
        }

        .chat-input-wrapper input {
            flex-grow: 1;
            background: #14171c;
            border: 1px solid #444;
            color: white;
            padding: 10px;
            border-radius: 6px;
            outline: none;
        }

        .btn-send {
            background: var(--accent);
            border: none;
            padding: 0 15px;
            border-radius: 6px;
            cursor: pointer;
            color: #000;
        }

        .btn-create-party {
            background: linear-gradient(45deg, #f1c40f, #f39c12);
            color: #000;
            padding: 12px 25px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: 0.3s;
            margin-bottom: 10px;
        }

        /* Lobby UI Styling */
        .lobby-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .lobby-card {
            background: #1a1d23;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #333;
            transition: 0.3s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .lobby-card:hover {
            border-color: var(--accent);
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
        }

        .lobby-card h4 {
            color: var(--accent);
            margin-bottom: 8px;
            font-size: 16px;
        }

        .lobby-card p {
            font-size: 13px;
            color: #aaa;
        }

        .lobby-status {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff4d4d;
            color: white;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .nav-main, .search-container, .user-action, .slider-thumbnails, .slide-btn { display: none; }
            .btn-mobile { display: block; }
            .hero-slider { height: 400px; }
            .slide-content h2 { font-size: 24px; }
            .slide-desc { display: none; }
            .popup-content { margin: 0; padding: 15px; width: 100%; border-radius: 0; }
            .popup-poster-inline { display: none; }
            .movie-item { min-width: 130px; max-width: 130px; }
            .lang-selector { justify-content: flex-start; }
            .player-wrapper { margin: 10px 0; border-radius: 4px; }
            .movie-item-top10 { min-width: 130px; }
            .top10-label { font-size: 10px; padding: 2px 6px; }
            .party-content { grid-template-columns: 1fr; }
            .bomtan-rank { font-size: 30px; left: -5px; bottom: -5px; }
        }

        footer {
            background-color: var(--bg-nav);
            padding: 40px 20px;
            margin-top: 50px;
            border-top: 1px solid #2d323a;
            text-align: center;
        }
        .footer-content h2 { color: var(--accent); font-size: 24px; margin-bottom: 10px; }
        .footer-content p { color: var(--text-dim); font-size: 14px; max-width: 600px; margin: 0 auto 20px; line-height: 1.6; }
        .back-to-top { position: fixed; bottom: 30px; right: 30px; background: var(--accent); color: black; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 1000; opacity: 0; visibility: hidden; transition: var(--transition); }
        .back-to-top.show { opacity: 1; visibility: visible; }
        .back-to-top:hover { transform: translateY(-5px); background: #fff; }

        .special-section {
            display: flex;
            align-items: center;
            gap: 20px;
            margin: 50px auto;
            max-width: 1600px;
            padding: 0 20px;
        }
        .thai-scroll {
            flex-grow: 1;
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding-bottom: 15px;
        }
        .thai-item {
            min-width: 250px;
            cursor: pointer;
        }
        .thai-thumb {
            width: 100%;
            aspect-ratio: 16/9;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        .thai-thumb img { width: 100%; height: 100%; object-fit: cover; }

        /* --- TOP PHIM ĐỀ CỬ DESIGN --- */
        .featured-banner {
            max-width: 1600px;
            margin: 100px auto 30px;
            padding: 0 20px;
        }
        .featured-banner h2 {
            font-size: 24px;
            margin-bottom: 20px;
            color: var(--text-main);
        }
        .banner-card {
            position: relative;
            width: 100%;
            height: 450px;
            border-radius: 15px;
            overflow: hidden;
            background: #1a1d23;
            display: flex;
            align-items: center;
        }
        .banner-img-bg {
            position: absolute;
            right: 0;
            top: 0;
            width: 70%;
            height: 100%;
            object-fit: cover;
            mask-image: linear-gradient(to left, rgba(0,0,0,1) 60%, transparent 100%);
            -webkit-mask-image: linear-gradient(to left, rgba(0,0,0,1) 60%, transparent 100%);
        }
        .banner-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to right, #1a1d23 30%, transparent 80%);
            z-index: 1;
        }
        .banner-info {
            position: relative;
            z-index: 2;
            padding: 40px;
            max-width: 500px;
        }
        .banner-info h1 { font-size: 36px; margin-bottom: 5px; }
        .banner-info .sub-title { color: var(--accent); margin-bottom: 15px; display: block; font-size: 14px; }
        .banner-meta { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .meta-tag { background: rgba(255,255,255,0.1); padding: 3px 10px; border-radius: 5px; font-size: 12px; color: #ccc; border: 1px solid #444; }
        .meta-tag.yellow { color: var(--accent); border-color: var(--accent); font-weight: bold; }
        .banner-desc { font-size: 14px; color: #aaa; line-height: 1.6; margin-bottom: 30px; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; }
        .banner-btns { display: flex; gap: 15px; align-items: center; }
        .btn-round { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: 0.3s; font-size: 18px; }
        .btn-play-yellow { background: var(--accent); color: #000; }
        .btn-action-gray { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid #555; }
        .btn-round:hover { transform: scale(1.1); }
        
        .banner-thumbnails {
            position: absolute;
            bottom: 20px;
            left: 40px;
            display: flex;
            gap: 12px;
            z-index: 5;
        }
        .banner-thumb-item {
            width: 60px;
            aspect-ratio: 2/3;
            border-radius: 5px;
            overflow: hidden;
            border: 2px solid transparent;
            cursor: pointer;
            transition: 0.3s;
        }
        .banner-thumb-item.active { border-color: var(--accent); transform: translateY(-5px); }
        .banner-thumb-item img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

<header id="mainHeader">
    <div class="container">
        <div class="btn-mobile" onclick="toggleMenu('mobileMenu')">
            <i class="fas fa-bars"></i>
        </div>

        <a href="#" class="logo-wrapper" onclick="window.location.reload()">
            <div class="logo-icon"><i class="fas fa-play-circle"></i></div>
            <div class="logo-text">
                <h1>XoPhim</h1>
                <span>Phim hay cả rổ</span>
            </div>
        </a>

        <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" id="desktopSearch" placeholder="Tìm kiếm phim, diễn viên..." onkeyup="if(event.key === 'Enter') handleSearch(this.value)">
        </div>

        <nav class="nav-main">
            <a href="#" class="nav-link">Chủ Đề</a>
            <div class="dropdown">
                <a class="nav-link" onclick="handleDropdownClick(event)">Thể loại <i class="fas fa-caret-down"></i></a>
                <div class="dropdown-content" id="genreDropdown">
                    </div>
            </div>
            <a href="#" class="nav-link" onclick="loadListPhim('phim-le')">Phim Lẻ</a>
            <a href="#" class="nav-link" onclick="loadListPhim('phim-bo')">Phim Bộ</a>
            <a href="#" class="nav-link" onclick="showLobby()" style="color: var(--accent); font-weight: bold;">Xem Chung</a>
            <div class="dropdown">
                <a class="nav-link" onclick="handleDropdownClick(event)">Quốc gia <i class="fas fa-caret-down"></i></a>
                <div class="dropdown-content" id="countryDropdown" style="min-width: 200px; grid-template-columns: 1fr;">
                    </div>
            </div>
            <a href="#" class="nav-link" id="actorLink">Diễn Viên</a>
            <a href="#" class="nav-link">Lịch Chiếu</a>
            <a href="#" class="nav-link"><span class="badge-new">NEW</span> Reviews</a>
        </nav>

        <div class="user-action">
            <button onclick="handleAuth()"><i class="fas fa-user"></i> Thành viên</button>
        </div>

        <div class="btn-mobile" onclick="toggleMenu('mobileSearch')">
            <i class="fas fa-search"></i>
        </div>
    </div>
</header>

<div id="mainContent">
    <section class="hero-slider">
        <div class="slider-container" id="heroSlider"></div>
        <div class="slider-thumbnails" id="heroThumbs"></div>
    </section>

    <section class="interest-section">
        <h3>Bạn đang quan tâm gì?</h3>
        <div class="interest-grid" id="interestGrid">
            </div>
    </section>

    <section class="movie-list-section" id="section-search" style="display:none;">
        <div class="list-header"><h3 id="searchTitle">Kết quả tìm kiếm</h3></div>
        <div class="movie-scroll" id="searchList"></div>
    </section>

    <section class="movie-list-section">
        <div class="list-header"><h3>Phim Hàn Quốc mới - Của Mấy má mê trai nè!</h3></div>
        <div class="slide-btn btn-left" onclick="slideMovies('koreanList', -1)"><i class="fas fa-chevron-left"></i></div>
        <div class="slide-btn btn-right" onclick="slideMovies('koreanList', 1)"><i class="fas fa-chevron-right"></i></div>
        <div class="movie-scroll" id="koreanList"></div>
    </section>

    <section class="movie-list-section">
        <div class="list-header"><h3>Phim Trung Quốc - Tổng tài của mấy má nè! </h3></div>
        <div class="slide-btn btn-left" onclick="slideMovies('chineseList', -1)"><i class="fas fa-chevron-left"></i></div>
        <div class="slide-btn btn-right" onclick="slideMovies('chineseList', 1)"><i class="fas fa-chevron-right"></i></div>
        <div class="movie-scroll" id="chineseList"></div>
    </section>

    <section class="movie-list-section">
        <div class="list-header">
            <h3>Phim Thái Lan Mới - Đây chắc chắn là của chị phiến nha!</h3>
            <a href="#" onclick="loadCountryPhim('thai-lan', 'searchList', 'Thái Lan')" style="margin-left: 15px; font-size: 14px; text-decoration: none; color: #ccc;">
                Xem toàn bộ <i class="fas fa-chevron-right"></i>
            </a>
        </div>
        <div class="slide-btn btn-left" onclick="slideMovies('thaiMoviesList', -1)"><i class="fas fa-chevron-left"></i></div>
        <div class="slide-btn btn-right" onclick="slideMovies('thaiMoviesList', 1)"><i class="fas fa-chevron-right"></i></div>
        <div class="movie-scroll" id="thaiMoviesList"></div>
    </section>

    <section class="movie-list-section">
        <div class="list-header"><h3>Phim US-UK, Mấy thằng tây nè! </h3></div>
        <div class="slide-btn btn-left" onclick="slideMovies('usukList', -1)"><i class="fas fa-chevron-left"></i></div>
        <div class="slide-btn btn-right" onclick="slideMovies('usukList', 1)"><i class="fas fa-chevron-right"></i></div>
        <div class="movie-scroll" id="usukList"></div>
    </section>

    <section class="movie-list-section">
        <div class="list-header"><h3>Phim Điện Ảnh Mới Coóng, Cứng Người Luôn! </h3></div>
        <div class="slide-btn btn-left" onclick="slideMovies('cinemaList', -1)"><i class="fas fa-chevron-left"></i></div>
        <div class="slide-btn btn-right" onclick="slideMovies('cinemaList', 1)"><i class="fas fa-chevron-right"></i></div>
        <div class="movie-scroll" id="cinemaList"></div>
    </section>

    <section class="movie-list-section">
        <div class="list-header"><h3>Điện Ảnh Hồng Kông ở Chỗ Này Này</h3></div>
        <div class="slide-btn btn-left" onclick="slideMovies('hkList', -1)"><i class="fas fa-chevron-left"></i></div>
        <div class="slide-btn btn-right" onclick="slideMovies('hkList', 1)"><i class="fas fa-chevron-right"></i></div>
        <div class="movie-scroll" id="hkList"></div>
    </section>

    <section class="movie-list-section">
        <div class="list-header"><h3>Tôi Sợ Con Người Em Rồi Đó, Nhưng Không Bằng Sợ Ma!</h3></div>
        <div class="slide-btn btn-left" onclick="slideMovies('horrorList', -1)"><i class="fas fa-chevron-left"></i></div>
        <div class="slide-btn btn-right" onclick="slideMovies('horrorList', 1)"><i class="fas fa-chevron-right"></i></div>
        <div class="movie-scroll" id="horrorList"></div>
    </section>

    <section class="movie-list-section">
        <div class="list-header"><h3>Top 10 Phim Bộ Hôm Nay Nhé Bồ!</h3></div>
        <div class="slide-btn btn-left" onclick="slideMovies('top10List', -1)"><i class="fas fa-chevron-left"></i></div>
        <div class="slide-btn btn-right" onclick="slideMovies('top10List', 1)"><i class="fas fa-chevron-right"></i></div>
        <div class="movie-scroll-top10" id="top10List"></div>
    </section>

    <section class="movie-list-section">
        <div class="list-header"><h3>Top Phim Bom Tấn Hay Nhức Nách luôn nè! </h3></div>
        <div class="slide-btn btn-left" onclick="slideMovies('bomTanList', -1)"><i class="fas fa-chevron-left"></i></div>
        <div class="slide-btn btn-right" onclick="slideMovies('bomTanList', 1)"><i class="fas fa-chevron-right"></i></div>
        <div class="movie-scroll-bomtan" id="bomTanList"></div>
    </section>

    <section class="movie-list-section">
        <div class="list-header"><h3>Top 10 Phim Lẻ Hay Nhức Nách (Mới nhất đang cập nhật lại nheng)</h3></div>
        <div class="slide-btn btn-left" onclick="slideMovies('top10LeList', -1)"><i class="fas fa-chevron-left"></i></div>
        <div class="slide-btn btn-right" onclick="slideMovies('top10LeList', 1)"><i class="fas fa-chevron-right"></i></div>
        <div class="movie-scroll-top10le" id="top10LeList"></div>
    </section>

    <section class="featured-banner">
        <h2>Top Phim Đề Cử - Coi đi hay lắm - mà tìm kiếm nha này tui gợi ý thôi </h2>
        <div class="banner-card" id="nominationBanner">
            <img src="" class="banner-img-bg" id="nomImg">
            <div class="banner-overlay"></div>
            <div class="banner-info">
                <h1 id="nomTitle">Đang tải...</h1>
                <span class="sub-title" id="nomSub">Loading...</span>
                <div class="banner-meta" id="nomMeta1">
                </div>
                <div class="banner-meta" id="nomMeta2">
                </div>
                <p class="banner-desc" id="nomDesc"></p>
                <div class="banner-btns" id="nomBtns">
                </div>
            </div>
            <div class="banner-thumbnails" id="nomThumbs">
            </div>
        </div>
    </section>
</div>

<footer>
    <div class="footer-content">
        <h2>Xô Phim</h2>
        <p>Xô Phim - Trang xem phim online chất lượng cao miễn phí Vietsub, thuyết minh, lồng tiếng full HD. Kho phim mới khổng lồ, phim chiếu rạp, phim bộ, phim lẻ từ nhiều quốc gia như Việt Nam, Hàn Quốc, Trung Quốc, Thái Lan, Nhật Bản, Âu Mỹ… đa dạng thể loại. Khám phá nền tảng phim trực tuyến hay nhất 2026 chất lượng 4K!</p>
        <div style="color: var(--text-dim); font-size: 15px;">
            &copy; 2026 XoPhim. Tui Là Đức Anh đẹp trai nhất làng!.
        </div>
    </div>
</footer>

<button class="back-to-top" id="backToTop" onclick="scrollToTop()">
    <i class="fas fa-chevron-up"></i>
</button>

<div class="popup-overlay" id="moviePopup">
    <div class="popup-content" id="popupContent"></div>
</div>

<div class="mobile-search-overlay" id="mobileSearch">
    <div class="search-mobile-header">
        <div class="search-mobile-bar">
            <input type="text" id="mobileSearchInput" placeholder="Tìm kiếm phim, diễn viên..." onkeypress="if(event.keyCode === 13) { handleSearch(this.value); }">
        </div>
        <div class="close-search-mobile" onclick="toggleMenu('mobileSearch')">
            <i class="fas fa-times"></i>
        </div>
    </div>
</div>

<div class="mobile-nav-overlay" id="mobileMenu">
    <div class="mobile-menu-card">
        <div class="close-mobile" onclick="toggleMenu('mobileMenu')">&times;</div>
        <button class="mobile-user-btn"><i class="fas fa-user"></i> Thành viên</button>
        <div class="mobile-grid">
            <a href="#">Chủ Đề</a>
            <button class="mobile-collapse-btn" onclick="toggleCollapse('colGenre')">
                Thể loại <i class="fas fa-caret-down"></i>
            </button>
            <div id="colGenre" class="mobile-collapse-content"></div>

            <a href="#" onclick="loadListPhim('phim-le'); toggleMenu('mobileMenu')">Phim Lẻ</a>
            <a href="#" onclick="loadListPhim('phim-bo'); toggleMenu('mobileMenu')">Phim Bộ</a>
            <a href="#" onclick="showLobby(); toggleMenu('mobileMenu')">Xem Chung</a>

            <button class="mobile-collapse-btn" onclick="toggleCollapse('colCountry')">
                Quốc gia <i class="fas fa-caret-down"></i>
            </button>
            <div id="colCountry" class="mobile-collapse-content"></div>

            <a href="#">Diễn Viên</a>
            <a href="#">Lịch Chiếu</a>
            <a href="#" style="grid-column: span 2;">
                <span><span class="badge-new">NEW</span> Reviews</span>
            </a>
        </div>
    </div>
</div>

<script>
    // --- CẤU HÌNH FIREBASE CỦA ĐỨC ANH ---
    const firebaseConfig = {
      apiKey: "AIzaSyBJ4fNO5gyq8IMR3hauWHEvpO15V5NRHsY",
      authDomain: "xophim.firebaseapp.com",
      databaseURL: "https://xophim-default-rtdb.firebaseio.com/",
      projectId: "xophim",
      storageBucket: "xophim.appspot.com",
      messagingSenderId: "616606303341",
      appId: "1:616606303341:web:388bebd2c18bb510e36b64",
      measurementId: "G-BLMRDM2WGH"
    };

    // Khởi tạo Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const API_NEW = 'https://phimapi.com/danh-sach/phim-moi-cap-nhat-v3?page=1';
    const API_DETAIL = 'https://phimapi.com/phim/';
    const API_GENRES = 'https://phimapi.com/the-loai';
    const API_COUNTRIES = 'https://phimapi.com/quoc-gia';
    const API_IMG = 'https://phimapi.com/image.php?url=';
    
    let currentSlide = 0;
    let slideCount = 0;
    let nominationMovies = [];
    let currentUser = JSON.parse(localStorage.getItem('xoPhim_User')) || null;
    let currentRoomID = null;

    // TRACKING TRANG ĐỂ LOAD VÔ TẬN
    let pageTracking = {
        'searchList': 1,
        'koreanList': 1,
        'chineseList': 1,
        'thaiMoviesList': 1,
        'usukList': 1,
        'cinemaList': 1,
        'hkList': 1,
        'horrorList': 1,
        'bomTanList': 1,
        'top10LeList': 1
    };

    async function slideMovies(id, direction) {
        const container = document.getElementById(id);
        const scrollAmount = container.offsetWidth * 0.8;
        container.scrollBy({ left: direction * scrollAmount, behavior: 'smooth' });

        // NẾU KÉO SANG PHẢI VÀ GẦN HẾT PHIM TRONG LIST THÌ LOAD THÊM TỪ API
        if (direction === 1 && (container.scrollLeft + container.offsetWidth >= container.scrollWidth - 300)) {
            pageTracking[id]++;
            
            let endpoint = '';
            if(id === 'koreanList') endpoint = 'quoc-gia/han-quoc';
            else if(id === 'chineseList') endpoint = 'quoc-gia/trung-quoc';
            else if(id === 'thaiMoviesList') endpoint = 'quoc-gia/thai-lan';
            else if(id === 'usukList') endpoint = 'quoc-gia/au-my';
            else if(id === 'cinemaList') endpoint = 'danh-sach/phim-le';
            else if(id === 'hkList') endpoint = 'quoc-gia/hong-kong';
            else if(id === 'horrorList') endpoint = 'the-loai/kinh-di';
            else if(id === 'bomTanList') endpoint = 'danh-sach/phim-le';
            else if(id === 'top10LeList') endpoint = 'danh-sach/phim-le';

            if(endpoint !== '') {
                try {
                    const res = await fetch(`https://phimapi.com/v1/api/${endpoint}?limit=20&page=${pageTracking[id]}`);
                    const data = await res.json();
                    if (data.data.items && data.data.items.length > 0) {
                        appendMovieList(data.data.items, id, (id === 'bomTanList' || id === 'top10LeList'), id === 'top10LeList');
                    }
                } catch (e) { console.error("Hết phim rồi Đức ơi", e); }
            }
        }
    }

    function appendMovieList(items, elementId, isRanked = false, isStyleBottom = false) {
        const container = document.getElementById(elementId);
        const currentCount = container.children.length;
        
        const html = items.map((m, i) => {
            if (isStyleBottom) {
                return `
                    <div class="top10le-item" onclick="showMovieDetail('${m.slug}')">
                        <div class="top10le-thumb">
                            <img src="${API_IMG}https://phimimg.com/${m.poster_url}" alt="${m.name}">
                        </div>
                        <div class="top10le-info">
                            <div class="top10le-rank">${currentCount + i + 1}</div>
                            <div class="top10le-detail">
                                <div class="top10le-title">${m.name}</div>
                                <div class="top10le-sub">${m.origin_name}</div>
                                <div class="top10le-meta">${m.year} • HD</div>
                            </div>
                        </div>
                    </div>`;
            }
            if (isRanked) {
                return `
                    <div class="bomtan-item" onclick="showMovieDetail('${m.slug}')">
                        <div class="bomtan-rank">${currentCount + i + 1}</div>
                        <div class="bomtan-thumb">
                            <img src="${API_IMG}https://phimimg.com/${m.poster_url}" alt="${m.name}">
                        </div>
                        <div class="bomtan-meta">
                            <div class="bomtan-title">${m.name}</div>
                            <div class="bomtan-info">${m.year} • HD</div>
                        </div>
                    </div>`;
            }
            return `
                <div class="movie-item" onclick="showMovieDetail('${m.slug}')">
                    <div class="movie-thumb">
                        <img src="${API_IMG}https://phimimg.com/${m.poster_url}" alt="${m.name}">
                        <span class="movie-badge">${m.year || 'Hot'}</span>
                    </div>
                    <div class="movie-title">${m.name}</div>
                </div>`;
        }).join('');
        container.insertAdjacentHTML('beforeend', html);
    }

    async function initSite() {
        try {
            const res = await fetch(API_NEW);
            const data = await res.json();
            const items = data.items.slice(0, 6);
            slideCount = items.length;

            const slider = document.getElementById('heroSlider');
            const thumbs = document.getElementById('heroThumbs');

            slider.innerHTML = items.map((m, i) => `
                <div class="slide-item">
                    <img src="${API_IMG}${m.thumb_url}" alt="${m.name}">
                    <div class="slide-overlay">
                        <div class="slide-content">
                            <span class="featured-tag">Featured Movie</span>
                            <h2>${m.name}</h2>
                            <div class="slide-meta">
                                <span class="imdb-badge">IMDb 8.5</span>
                                <span class="meta-text">${m.year}</span>
                                <span class="meta-text">125 phút</span>
                                <span class="meta-text">Hành động, Viễn tưởng</span>
                            </div>
                            <p class="slide-desc">${m.origin_name} - Trải nghiệm siêu phẩm điện ảnh với chất lượng hình ảnh và âm thanh tuyệt đỉnh chỉ có tại XoPhim.</p>
                            <div class="hero-btn-group">
                                <a href="#" class="btn-hero btn-play-hero" onclick="showMovieDetail('${m.slug}')">
                                    <i class="fas fa-play"></i> XEM NGAY
                                </a>
                                <a href="#" class="btn-hero btn-trailer-hero" onclick="showMovieDetail('${m.slug}')">
                                    <i class="fas fa-trailer"></i> TRAILER
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            thumbs.innerHTML = items.map((m, i) => `
                <div class="thumb-item ${i===0?'active':''}" onclick="goToSlide(${i})">
                    <img src="${API_IMG}${m.poster_url}" alt="thumb">
                </div>
            `).join('');

            setInterval(() => {
                currentSlide = (currentSlide + 1) % slideCount;
                goToSlide(currentSlide);
            }, 5000);

            loadMenuData();
            loadCountryPhim('han-quoc', 'koreanList');
            loadCountryPhim('trung-quoc', 'chineseList');
            loadThaiMovies(); 
            loadCountryPhim('au-my', 'usukList');
            loadCinemaPhim();
            loadCountryPhim('hong-kong', 'hkList');
            loadCategoryPhim('kinh-di', 'horrorList');
            loadTop10Phim();
            loadBomTanPhim();
            loadTop10PhimLe();
            loadNominationData(); 
            updateHeaderAuth();

        } catch (e) { console.error("Lỗi khởi tạo", e); }
    }

    async function loadBomTanPhim() {
        try {
            const res = await fetch(`https://phimapi.com/v1/api/danh-sach/phim-le?limit=10&page=1`);
            const data = await res.json();
            const container = document.getElementById('bomTanList');
            container.innerHTML = data.data.items.map((m, index) => `
                <div class="bomtan-item" onclick="showMovieDetail('${m.slug}')">
                    <div class="bomtan-rank">${index + 1}</div>
                    <div class="bomtan-thumb">
                        <img src="${API_IMG}https://phimimg.com/${m.poster_url}" alt="${m.name}">
                    </div>
                    <div class="bomtan-meta">
                        <div class="bomtan-title">${m.name}</div>
                        <div class="bomtan-info">${m.year} • HD</div>
                    </div>
                </div>
            `).join('');
        } catch (e) { console.error(e); }
    }

    async function loadTop10PhimLe() {
        try {
            const res = await fetch(`https://phimapi.com/v1/api/danh-sach/phim-le?limit=10&page=1`);
            const data = await res.json();
            const container = document.getElementById('top10LeList');
            container.innerHTML = data.data.items.map((m, index) => `
                <div class="top10le-item" onclick="showMovieDetail('${m.slug}')">
                    <div class="top10le-thumb">
                        <img src="${API_IMG}https://phimimg.com/${m.poster_url}" alt="${m.name}">
                    </div>
                    <div class="top10le-info">
                        <div class="top10le-rank">${index + 1}</div>
                        <div class="top10le-detail">
                            <div class="top10le-title">${m.name}</div>
                            <div class="top10le-sub">${m.origin_name}</div>
                            <div class="top10le-meta">${m.year} • HD</div>
                        </div>
                    </div>
                </div>
            `).join('');
        } catch (e) { console.error(e); }
    }

    // AUTH SYSTEM
    function handleAuth() {
        if (!currentUser) {
            const name = prompt("Nhập tên hiển thị của bạn để vào XoPhim:", "");
            if (name && name.trim().length > 1) {
                currentUser = { name: name.trim(), id: "user_" + Date.now() };
                localStorage.setItem('xoPhim_User', JSON.stringify(currentUser));
                updateHeaderAuth();
                alert("Đăng nhập thành công!");
                location.reload();
            }
        } else {
            if(confirm("Đăng xuất tài khoản " + currentUser.name + "?")) {
                localStorage.removeItem('xoPhim_User');
                currentUser = null;
                updateHeaderAuth();
                location.reload();
            }
        }
    }

    function updateHeaderAuth() {
        const btns = document.querySelectorAll('.user-action button, .mobile-user-btn');
        btns.forEach(btn => {
            if (currentUser) {
                btn.innerHTML = `<i class="fas fa-user-circle"></i> ${currentUser.name}`;
                btn.style.color = "var(--accent)";
            } else {
                btn.innerHTML = `<i class="fas fa-user"></i> Thành viên`;
                btn.style.color = "";
            }
        });
    }

    // XEM CHUNG LOBBY
    function showLobby() {
        const main = document.getElementById('mainContent');
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        main.innerHTML = `
            <section class="movie-list-section" style="margin-top:100px;">
                <div class="list-header">
                    <h3><i class="fas fa-broadcast-tower"></i> Sảnh Xem Chung - Các phòng đang Live (Giới hạn 3 người)</h3>
                    <button onclick="window.location.reload()" style="background:none; border:1px solid #444; color:white; padding:5px 15px; border-radius:20px; cursor:pointer;">Quay lại Trang chủ</button>
                </div>
                <div id="lobbyList" class="lobby-grid">Đang quét các phòng từ hệ thống...</div>
            </section>
        `;

        database.ref('active_rooms').on('value', (snapshot) => {
            const rooms = snapshot.val();
            const container = document.getElementById('lobbyList');
            if (!container) return;
            if (!rooms) { 
                container.innerHTML = "<p style='padding:20px; color:#888;'>Hiện chưa có phòng nào đang Live. Hãy mở một bộ phim và tạo phòng đầu tiên!</p>"; 
                return; 
            }
            
            container.innerHTML = Object.keys(rooms).map(key => {
                const r = rooms[key];
                const memberCount = r.members ? Object.keys(r.members).length : 0;
                const isFull = memberCount >= 3;
                return `
                    <div class="lobby-card" onclick="${isFull ? 'alert(\'Phòng đã đủ 3 người!\')' : `showMovieDetail('${r.slug}')`}">
                        <div class="lobby-status" style="background:${isFull ? '#666' : '#ff4d4d'}">${isFull ? 'FULL' : 'LIVE'}</div>
                        <h4>${r.movieName}</h4>
                        <p><i class="fas fa-user"></i> Chủ phòng: ${r.host}</p>
                        <p style="margin-top:10px; color:${isFull ? '#666' : 'var(--accent)'}; font-weight:bold;">
                            ${isFull ? 'Phòng đầy (3/3)' : `Tham gia (${memberCount}/3) <i class="fas fa-chevron-right"></i>`}
                        </p>
                    </div>
                `;
            }).join('');
        });
    }

    // TOP ĐỀ CỬ
    async function loadNominationData() {
        try {
            const res = await fetch('https://phimapi.com/v1/api/danh-sach/phim-bo?limit=4');
            const data = await res.json();
            nominationMovies = data.data.items;
            
            const thumbContainer = document.getElementById('nomThumbs');
            thumbContainer.innerHTML = nominationMovies.map((m, i) => `
                <div class="banner-thumb-item ${i === 0 ? 'active' : ''}" onclick="updateNominationUI(${i})">
                    <img src="${API_IMG}https://phimimg.com/${m.poster_url}">
                </div>
            `).join('');

            updateNominationUI(0);
        } catch (e) { console.error("Lỗi tải đề cử", e); }
    }

    async function updateNominationUI(index) {
        const m = nominationMovies[index];
        const resDetail = await fetch(API_DETAIL + m.slug);
        const detail = await resDetail.json();
        const movie = detail.movie;

        document.getElementById('nomImg').src = API_IMG + movie.thumb_url;
        document.getElementById('nomTitle').innerText = movie.name;
        document.getElementById('nomSub').innerText = movie.origin_name;
        document.getElementById('nomDesc').innerText = movie.content.replace(/<[^>]*>/g, '').substring(0, 250) + '...';
        
        document.getElementById('nomMeta1').innerHTML = `
            <span class="meta-tag yellow">IMDb ${movie.tmdb?.vote_average || '8.0'}</span>
            <span class="meta-tag">${movie.year}</span>
            <span class="meta-tag">${movie.quality}</span>
            <span class="meta-tag">${movie.episode_current}</span>
        `;

        document.getElementById('nomMeta2').innerHTML = movie.category.slice(0, 4).map(c => `<span class="meta-tag">${c.name}</span>`).join('');
        
        document.getElementById('nomBtns').innerHTML = `
            <button class="btn-round btn-play-yellow" onclick="showMovieDetail('${movie.slug}')"><i class="fas fa-play"></i></button>
            <button class="btn-round btn-action-gray"><i class="far fa-heart"></i></button>
            <button class="btn-round btn-action-gray"><i class="fas fa-exclamation"></i></button>
        `;

        document.querySelectorAll('.banner-thumb-item').forEach((t, i) => {
            t.classList.toggle('active', i === index);
        });
    }

    async function loadMenuData() {
        try {
            const [genRes, counRes] = await Promise.all([fetch(API_GENRES), fetch(API_COUNTRIES)]);
            const genres = await genRes.json();
            const countries = await counRes.json();

            const genreHtml = genres.map(g => `<a href="#" onclick="loadCategoryPhim('${g.slug}', 'searchList', '${g.name}')">${g.name}</a>`).join('');
            document.getElementById('genreDropdown').innerHTML = genreHtml;
            document.getElementById('colGenre').innerHTML = genreHtml;

            const colors = ['#3b5bdb', '#20c997', '#748ffc', '#9775fa', '#ff922b', '#fa5252'];
            document.getElementById('interestGrid').innerHTML = genres.slice(0, 6).map((g, i) => `
                <a href="#" class="interest-card" style="background: ${colors[i]}" onclick="loadCategoryPhim('${g.slug}', 'searchList', '${g.name}')">
                    <span>${g.name}</span>
                    <div class="sub-text">Xem ngay <i class="fas fa-chevron-right"></i></div>
                </a>
            `).join('') + `<a href="#" class="interest-card" style="background: #252931; align-items: center; justify-content: center;"><span>+${genres.length-6} chủ đề</span></a>`;

            const countryHtml = countries.map(c => `<a href="#" onclick="loadCountryPhim('${c.slug}', 'searchList', '${c.name}')">${c.name}</a>`).join('');
            document.getElementById('countryDropdown').innerHTML = countryHtml;
            document.getElementById('colCountry').innerHTML = countryHtml;

        } catch (e) { console.error("Lỗi load menu", e); }
    }

    function closeAllMenus() {
        document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('open'));
        document.getElementById('mobileMenu').classList.remove('active');
        document.getElementById('mobileSearch').classList.remove('active');
    }

    async function handleSearch(keyword, isLoadMore = false) {
        if (!keyword) return;
        if (!isLoadMore) {
            closeAllMenus();
            pageTracking['searchList'] = 1;
            document.getElementById('section-search').style.display = 'block';
            document.getElementById('searchTitle').innerText = `Kết quả cho: ${keyword}`;
            document.getElementById('searchList').innerHTML = '<p style="padding:20px;">Đang tìm kiếm...</p>';
        } else {
            pageTracking['searchList']++;
        }

        try {
            const res = await fetch(`https://phimapi.com/v1/api/tim-kiem?keyword=${keyword}&limit=20&page=${pageTracking['searchList']}`);
            const data = await res.json();
            
            if (!isLoadMore) {
                renderMovieList(data.data.items, 'searchList');
                window.scrollTo({ top: document.getElementById('section-search').offsetTop - 100, behavior: 'smooth' });
            } else {
                appendMovieList(data.data.items, 'searchList');
            }

            // THÊM NÚT XEM THÊM CHO PHẦN SEARCH
            let btnMore = document.getElementById('btnSearchMore');
            if(!btnMore) {
                document.getElementById('section-search').insertAdjacentHTML('beforeend', 
                    `<button id="btnSearchMore" onclick="handleSearch('${keyword}', true)" style="display:block; margin:20px auto; padding:10px 30px; background:var(--accent); border:none; border-radius:20px; font-weight:bold; cursor:pointer; color:#000;">XEM THÊM KẾT QUẢ</button>`
                );
            }
            
            if (data.data.items.length < 20) {
                if(btnMore) btnMore.style.display = 'none';
            } else if(btnMore) {
                btnMore.style.display = 'block';
            }

        } catch (e) { console.error(e); }
    }

    async function loadListPhim(type) {
        closeAllMenus();
        document.getElementById('section-search').style.display = 'block';
        document.getElementById('searchTitle').innerText = type === 'phim-le' ? 'Phim Lẻ Mới' : 'Phim Bộ Mới';
        try {
            const res = await fetch(`https://phimapi.com/v1/api/danh-sach/${type}?limit=30`);
            const data = await res.json();
            renderMovieList(data.data.items, 'searchList');
            window.scrollTo({ top: document.getElementById('section-search').offsetTop - 100, behavior: 'smooth' });
        } catch (e) { console.error(e); }
    }

    async function loadTop10Phim() {
        try {
            const res = await fetch(`https://phimapi.com/v1/api/danh-sach/phim-bo?limit=10`);
            const data = await res.json();
            const items = data.data.items;
            const container = document.getElementById('top10List');
            container.innerHTML = items.map((m, index) => `
                <div class="movie-item-top10" onclick="showMovieDetail('${m.slug}')">
                    <div class="top10-label"><i class="fas fa-crown"></i> TOP ${index + 1}</div>
                    <div class="top10-thumb">
                        <img src="${API_IMG}https://phimimg.com/${m.poster_url}" alt="${m.name}">
                    </div>
                    <div class="top10-meta">
                        <div class="top10-title">${m.name}</div>
                        <div class="top10-sub">${m.origin_name}</div>
                        <div class="top10-info">Phần ${m.year || 1} • Tập ${m.episode_current?.split(' ')[1] || '??'}</div>
                    </div>
                </div>
            `).join('');
        } catch (e) { console.error(e); }
    }

    async function loadThaiMovies() {
        try {
            const res = await fetch(`https://phimapi.com/v1/api/quoc-gia/thai-lan?limit=10`);
            const data = await res.json();
            const items = data.data.items;
            const container = document.getElementById('thaiMoviesList');
            container.innerHTML = items.map(m => `
                <div class="thai-item" onclick="showMovieDetail('${m.slug}')">
                    <div class="thai-thumb">
                        <img src="${API_IMG}https://phimimg.com/${m.poster_url}" alt="${m.name}">
                        <span class="movie-badge">${m.episode_current || 'HD'}</span>
                    </div>
                    <div class="movie-title" style="white-space: normal;">${m.name}</div>
                    <div style="font-size: 11px; color: #666;">${m.origin_name}</div>
                </div>
            `).join('');
        } catch (e) { console.error(e); }
    }

    function renderMovieList(items, elementId) {
        const container = document.getElementById(elementId);
        if (!items || items.length === 0) {
            container.innerHTML = '<p style="padding:20px;">Không tìm thấy phim nào.</p>';
            return;
        }
        container.innerHTML = items.map(m => `
            <div class="movie-item" onclick="showMovieDetail('${m.slug}')">
                <div class="movie-thumb">
                    <img src="${API_IMG}https://phimimg.com/${m.poster_url}" alt="${m.name}">
                    <span class="movie-badge">${m.year || 'Hot'}</span>
                </div>
                <div class="movie-title">${m.name}</div>
            </div>
        `).join('');
    }

    async function loadCinemaPhim() {
        try {
            const res = await fetch(`https://phimapi.com/v1/api/danh-sach/phim-le?limit=20`);
            const data = await res.json();
            renderMovieList(data.data.items, 'cinemaList');
        } catch (e) { console.error(e); }
    }

    async function loadCountryPhim(slug, elementId, name = null) {
        if(name) {
            closeAllMenus();
            document.getElementById('section-search').style.display = 'block';
            document.getElementById('searchTitle').innerText = `Phim ${name}`;
        }
        try {
            const res = await fetch(`https://phimapi.com/v1/api/quoc-gia/${slug}?limit=20`);
            const data = await res.json();
            renderMovieList(data.data.items, elementId);
            if(name) window.scrollTo({ top: document.getElementById('section-search').offsetTop - 100, behavior: 'smooth' });
        } catch (e) { console.error(e); }
    }

    async function loadCategoryPhim(slug, elementId, name = null) {
        if(name) {
            closeAllMenus();
            document.getElementById('section-search').style.display = 'block';
            document.getElementById('searchTitle').innerText = `Thể loại: ${name}`;
        }
        try {
            const res = await fetch(`https://phimapi.com/v1/api/the-loai/${slug}?limit=20`);
            const data = await res.json();
            renderMovieList(data.data.items, elementId);
            if(name) window.scrollTo({ top: document.getElementById('section-search').offsetTop - 100, behavior: 'smooth' });
        } catch (e) { console.error(e); }
    }

    // DETAIL & WATCH PARTY LOGIC
    async function showMovieDetail(slug) {
        try {
            const res = await fetch(API_DETAIL + slug);
            const data = await res.json();
            const movie = data.movie;
            const episodeServers = data.episodes; 
            const popup = document.getElementById('moviePopup');
            const defaultLink = episodeServers[0].server_data[0].link_embed;

            document.getElementById('popupContent').innerHTML = `
                <span class="close-popup" onclick="closePopup()">&times;</span>
                <h2 style="font-size:24px; margin-bottom:15px; border-left: 5px solid var(--accent); padding-left: 15px;">${movie.name}</h2>
                <div class="player-wrapper">
                    <iframe id="videoIframe" src="${defaultLink}" allowfullscreen allow="autoplay; encrypted-media"></iframe>
                </div>
                <div style="overflow: auto; margin-top: 20px;">
                    <img src="${API_IMG}${movie.poster_url}" class="popup-poster-inline">
                    <div style="overflow: hidden;">
                        <div class="slide-meta">
                            <span class="meta-item imdb-tag">IMDb ${movie.tmdb?.vote_average || 'N/A'}</span>
                            <span class="meta-item">${movie.year}</span>
                            <span class="meta-item">${movie.quality}</span>
                        </div>
                        <div style="font-size:12px; color:var(--accent); margin-bottom:10px;">Diễn viên: ${movie.actor.join(', ')}</div>
                        
                        <div id="roomActionArea">
                            ${currentUser ? 
                                `<button class="btn-create-party" onclick="initWatchParty('${movie.name.replace(/'/g, "\\'")}', '${slug}')">
                                    <i class="fas fa-users"></i> BẮT ĐẦU XEM CHUNG & CHAT
                                </button>` : 
                                `<button class="btn-create-party" style="opacity: 0.6; cursor: pointer;" onclick="handleAuth()">
                                    <i class="fas fa-lock"></i> ĐĂNG NHẬP ĐỂ XEM CHUNG
                                </button>`
                            }
                        </div>

                        <div style="font-weight:bold; margin-top:15px; font-size:14px;">Chọn Server:</div>
                        <div class="lang-selector">
                            ${episodeServers.map((server, idx) => `<button class="lang-btn ${idx === 0 ? 'active' : ''}" onclick="switchLang(this, ${idx})">${server.server_name}</button>`).join('')}
                        </div>
                        <div style="font-weight:bold; margin-top:5px; font-size:14px;">Chọn Tập:</div>
                        <div id="epContainer" class="episode-grid">
                            ${episodeServers[0].server_data.map((ep, idx) => `<button class="ep-btn ${idx === 0 ? 'active' : ''}" onclick="playVideo(this, '${ep.link_embed}')">${ep.name}</button>`).join('')}
                        </div>
                        <p style="color:#aaa; line-height:1.6; margin-top:20px; font-size:13px; border-top:1px solid #333; padding-top:15px;">${movie.content}</p>
                        
                        <div id="watchPartyArea"></div>
                    </div>
                </div>
            `;
            window.currentMovieEpisodes = episodeServers;
            popup.style.display = 'block';
            document.body.style.overflow = 'hidden';
        } catch (e) { alert("Lỗi tải thông tin phim!"); }
    }

    // ĐỒNG BỘ VIDEO & GIỚI HẠN NGƯỜI
    function initWatchParty(movieName, slug) {
        if (!currentUser) return;
        currentRoomID = slug;
        const area = document.getElementById('watchPartyArea');
        const roomRef = database.ref('active_rooms/' + slug);

        // Kiểm tra số lượng người trước khi vào
        roomRef.get().then((snapshot) => {
            const roomData = snapshot.val();
            const members = roomData?.members || {};
            if (Object.keys(members).length >= 3 && !members[currentUser.id]) {
                alert("Phòng này đã đủ 3 người!");
                return;
            }

            // Đăng ký mình vào phòng
            roomRef.update({
                movieName: movieName,
                slug: slug,
                host: roomData?.host || currentUser.name,
                timestamp: Date.now()
            });
            roomRef.child('members').child(currentUser.id).set(currentUser.name);
            roomRef.child('members').child(currentUser.id).onDisconnect().remove();

            document.getElementById('roomActionArea').style.display = 'none';
            area.innerHTML = `
                <div class="watch-party-layout">
                    <div class="room-header">
                        <div>
                            <h3 style="font-size: 16px;">Phòng chat phim: ${movieName}</h3>
                            <p style="font-size: 12px; color: #aaa;" id="memberListDisplay">Đang cập nhật thành viên...</p>
                        </div>
                        <div class="live-indicator"><div class="live-dot"></div><span>ĐANG XEM</span></div>
                    </div>
                    <div class="party-content">
                        <div class="chat-section">
                            <div class="chat-messages" id="chatStream"></div>
                            <div class="chat-input-wrapper">
                                <input type="text" id="msgInput" placeholder="Nói gì đó..." onkeypress="if(event.key === 'Enter') sendMessage('${slug}')">
                                <button class="btn-send" onclick="sendMessage('${slug}')"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Lắng nghe thay đổi thành viên
            roomRef.child('members').on('value', (s) => {
                const m = s.val() || {};
                const display = document.getElementById('memberListDisplay');
                if(display) display.innerText = "Thành viên: " + Object.values(m).join(', ');
            });

            // Lắng nghe đồng bộ video (Tập phim)
            roomRef.child('currentSync').on('value', (s) => {
                const sync = s.val();
                if (sync && sync.user !== currentUser.name) {
                    const iframe = document.getElementById('videoIframe');
                    if (iframe && iframe.src !== sync.link) {
                        iframe.src = sync.link;
                        alert(sync.user + " vừa chuyển tập phim!");
                    }
                }
            });

            const chatRef = database.ref('chats/' + slug);
            chatRef.off();
            chatRef.limitToLast(20).on('child_added', (snapshot) => {
                renderMessage(snapshot.val());
            });
        });
    }

    function sendMessage(roomID) {
        const input = document.getElementById('msgInput');
        if (!input || !input.value.trim() || !currentUser) return;
        database.ref('chats/' + roomID).push({
            user: currentUser.name,
            text: input.value,
            timestamp: Date.now()
        });
        input.value = "";
    }

    function renderMessage(data) {
        const stream = document.getElementById('chatStream');
        if(!stream) return;
        const isMe = currentUser && data.user === currentUser.name;
        stream.insertAdjacentHTML('beforeend', `
            <div class="message-item" style="${isMe ? 'align-self: flex-end; background:rgba(241,196,15,0.2); border-right: 3px solid var(--accent);' : ''}">
                <span class="user-name">${data.user}</span>
                <span class="text">${data.text}</span>
            </div>
        `);
        stream.scrollTop = stream.scrollHeight;
    }

    window.playVideo = function(btn, link) {
        document.querySelectorAll('.ep-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const iframe = document.getElementById('videoIframe');
        if(iframe) {
            iframe.src = "about:blank"; 
            setTimeout(() => { iframe.src = link; }, 100);
        }
        const popup = document.getElementById('moviePopup');
        if(popup) popup.scrollTo({ top: 0, behavior: 'smooth' });

        // Đồng bộ với phòng nếu đang ở trong phòng
        if (currentRoomID) {
            database.ref('active_rooms/' + currentRoomID + '/currentSync').set({
                link: link,
                user: currentUser.name,
                timestamp: Date.now()
            });
        }
    };

    window.switchLang = function(btn, serverIdx) {
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const serverData = window.currentMovieEpisodes[serverIdx].server_data;
        const newEpisodes = serverData.map((ep, idx) => `<button class="ep-btn ${idx === 0 ? 'active' : ''}" onclick="playVideo(this, '${ep.link_embed}')">${ep.name}</button>`).join('');
        const epContainer = document.getElementById('epContainer');
        if(epContainer) {
            epContainer.innerHTML = newEpisodes;
            playVideo(epContainer.querySelector('.ep-btn'), serverData[0].link_embed);
        }
    };

    function closePopup() {
        const iframe = document.getElementById('videoIframe');
        if(iframe) iframe.src = ""; 
        document.getElementById('moviePopup').style.display = 'none';
        document.body.style.overflow = 'auto';
        
        // Rời phòng nếu có
        if (currentRoomID && currentUser) {
            database.ref('active_rooms/' + currentRoomID + '/members/' + currentUser.id).remove();
            currentRoomID = null;
        }
    }

    function goToSlide(i) {
        currentSlide = i;
        const slider = document.getElementById('heroSlider');
        if(slider) { slider.style.transform = `translateX(-${i * 100}%)`; }
        document.querySelectorAll('.thumb-item').forEach((t, idx) => {
            t.classList.toggle('active', idx === i);
        });
    }

    initSite();

    window.addEventListener('scroll', () => {
        const header = document.getElementById('mainHeader');
        const backToTopBtn = document.getElementById('backToTop');
        if (header && window.scrollY > 50) { header.classList.add('scrolled'); } 
        else if (header) { header.classList.remove('scrolled'); }
        if (backToTopBtn && window.scrollY > 400) { backToTopBtn.classList.add('show'); } 
        else if (backToTopBtn) { backToTopBtn.classList.remove('show'); }
    });

    function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }

    function handleDropdownClick(event) {
        event.preventDefault();
        const parent = event.currentTarget.closest('.dropdown');
        document.querySelectorAll('.dropdown').forEach(d => { if (d !== parent) d.classList.remove('open'); });
        parent.classList.toggle('open');
    }

    function toggleMenu(id) {
        const menu = document.getElementById(id);
        if(!menu) return;
        menu.classList.toggle('active');
        if(id === 'mobileSearch' && menu.classList.contains('active')) {
            setTimeout(() => { document.getElementById('mobileSearchInput').focus(); }, 300);
        }
    }

    function toggleCollapse(id) {
        const content = document.getElementById(id);
        content.classList.toggle('active');
        const btn = content.previousElementSibling;
        const icon = btn.querySelector('i');
        if(content.classList.contains('active')) {
            icon.style.transform = "rotate(180deg)";
            icon.style.color = "var(--accent)";
        } else {
            icon.style.transform = "rotate(0deg)";
            icon.style.color = "white";
        }
    }

    window.onclick = function(event) {
        if (event.target.classList.contains('mobile-nav-overlay')) event.target.classList.remove('active');
        if (event.target.classList.contains('mobile-search-overlay')) event.target.classList.remove('active');
        if (event.target.classList.contains('popup-overlay')) closePopup();
        if (!event.target.closest('.dropdown')) {
            document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('open'));
        }
    }

    // --- HỆ THỐNG BẢO MẬT CHỐNG COPPY & SOI CODE ---
    // 1. Chặn chuột phải
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
    }, false);

    // 2. Chặn các phím tắt DevTools
    document.addEventListener('keydown', function(e) {
        // Chặn F12
        if (e.keyCode === 123) {
            e.preventDefault();
            return false;
        }
        // Chặn Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+Shift+C (Inspect)
        if (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74 || e.keyCode === 67)) {
            e.preventDefault();
            return false;
        }
        // Chặn Ctrl+U (View Source)
        if (e.ctrlKey && e.keyCode === 85) {
            e.preventDefault();
            return false;
        }
        // Chặn Ctrl+S (Save page)
        if (e.ctrlKey && e.keyCode === 83) {
            e.preventDefault();
            return false;
        }
    }, false);
</script>
</body>
</html>
